

namespace QstReport.Report.Excel
{
    using QstReport.DataModel;
    using QstReport.Utils;
    using System;
    using System.Collections.Generic;
    using System.Drawing;
    using System.Linq;
    using System.Text;
    using System.Threading.Tasks;
    using xL = Microsoft.Office.Interop.Excel;

    public sealed class LastWeekExploitEventReportSheetWriter
    {
        private static readonly Color TableHeaderBackgroundColor = Color.LightGray;
        private static readonly Color DayHeaderBackgroundColor = Color.Bisque;

        public void CreateReport(xL.Worksheet sheet, TimePeriod period, IEnumerable<ExploitEvent> exploitEvents)
        {
            var rowIndex = 1; // Index de ligne
            var columnsHeader = new string[] { "Evt Technique", "Début", "Durée", "Titre", "Description" };
            var columnCount = columnsHeader.Length;

            var reportTitle = string.Format("Bilan des évènements techniques reportés dans EPEIRES pour la période du {0:d} au {1:d}", period.Start, period.End);


            /* Titre de la feuille */
            rowIndex += WritePageTitle(sheet, rowIndex, columnCount, reportTitle);

            /* Nb AVT de la semaine */
            rowIndex += WriteNumberOfItems(sheet, rowIndex, exploitEvents.Count());

            /* En-tête du tableau */
            rowIndex += WriteTableHeader(sheet, rowIndex, columnsHeader);

            /* Affichage par subdivision */
            var groupedBy = exploitEvents.GroupBy(x => x.StartDate.Date).OrderBy(x => x.Key);
            foreach (var group in groupedBy)
            {
                /* Nom de la subdivision */
                rowIndex += WriteTableSubHeader(sheet, rowIndex, columnCount, DayHeaderBackgroundColor, group.Key.ToLongDateString());

                foreach (var exploitEvent in group.OrderBy(x => x.StartDate))
                {
                    sheet.Cells[rowIndex, 1] = string.Empty; // Ref SIAM
                    sheet.Cells[rowIndex, 2] = "'" + exploitEvent.StartDate.ToString("hh:mm");
                    sheet.Cells[rowIndex, 3] = "'" + (exploitEvent.EndDate.HasValue ? (exploitEvent.EndDate.Value - exploitEvent.StartDate).TotalHours.ToString("F2") + " H" : "---");
                    sheet.Cells[rowIndex, 4] = exploitEvent.Title;
                    sheet.Cells[rowIndex, 5] = exploitEvent.Description; 
                    
                    sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].BorderAround(xL.XlLineStyle.xlContinuous);
                    sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].Borders.Item(xL.XlBordersIndex.xlInsideVertical).LineStyle = xL.XlLineStyle.xlContinuous;
                    sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].VerticalAlignment = xL.XlVAlign.xlVAlignCenter;

                    rowIndex++;
                }
            }

            rowIndex++; // insère une ligne vide entre la dernière ligne du tableau et le début du footer

            // pied de page
            rowIndex += WritePageFooter(sheet, rowIndex, columnCount, string.Format("Edité le {0:d} à {0:t}", DateTime.Now));

            /* Mise en page finale */

            // pour faciliter l'impression la largeur des colonnes est fixée
            sheet.Columns[1].ColumnWidth = 16;
            sheet.Columns[2].ColumnWidth = 8;
            sheet.Columns[3].ColumnWidth = 8;
            sheet.Columns[4].WrapText = true;
            sheet.Columns[4].ColumnWidth = 35;
            sheet.Columns[5].WrapText = true;
            sheet.Columns[5].ColumnWidth = 68;

            // Force rows height to cells content
            sheet.Range[sheet.Cells[1, 1], sheet.Cells[rowIndex, 1]].Rows.AutoFit();


            sheet.Columns[1].HorizontalAlignment = xL.XlHAlign.xlHAlignCenter;
            sheet.Columns[2].HorizontalAlignment = xL.XlHAlign.xlHAlignCenter;
            sheet.Columns[3].HorizontalAlignment = xL.XlHAlign.xlHAlignCenter;
            sheet.Columns[4].HorizontalAlignment = xL.XlHAlign.xlHAlignCenter;
            sheet.Columns[5].HorizontalAlignment = xL.XlHAlign.xlHAlignLeft;
        }

        private int WritePageTitle(xL.Worksheet sheet, int rowIndex, int columnCount, string title)
        {
            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].Merge();
            sheet.Cells[rowIndex, 1].Font.Size = 14;
            sheet.Cells[rowIndex, 1].Font.Bold = true;
            sheet.Cells[rowIndex, 1].HorizontalAlignment = xL.XlHAlign.xlHAlignCenter;
            sheet.Cells[rowIndex, 1] = title;

            return 2; // 1 ligne écrite + 1 ligne vide
        }

        private int WritePageFooter(xL.Worksheet sheet, int rowIndex, int columnCount, string text)
        {
            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].Merge();
            sheet.Cells[rowIndex, 1].HorizontalAlignment = xL.XlHAlign.xlHAlignCenter;
            sheet.Cells[rowIndex, 1] = text;

            return 1;
        }

        private int WriteNumberOfItems(xL.Worksheet sheet, int rowIndex, long numberOfAvt)
        {
            sheet.Cells[rowIndex, 1].Font.Bold = true;
            sheet.Cells[rowIndex, 1].HorizontalALignment = xL.XlHAlign.xlHAlignRight;
            sheet.Cells[rowIndex, 1] = "Nb évènement : ";
            sheet.Cells[rowIndex, 2].Font.Bold = true;
            sheet.Cells[rowIndex, 2] = numberOfAvt;

            return 2; // 1 ligne écrite + 1 ligne vide
        }

        private int WriteTableHeader(xL.Worksheet sheet, int rowIndex, string[] columnHeaders)
        {
            var columnCount = columnHeaders.Length;

            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].Font.Bold = true;
            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].Interior.Color = ColorTranslator.ToOle(TableHeaderBackgroundColor);
            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].HorizontalAlignment = xL.XlHAlign.xlHAlignCenter;
            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].BorderAround(xL.XlLineStyle.xlContinuous);
            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].Borders.Item(xL.XlBordersIndex.xlInsideVertical).LineStyle = xL.XlLineStyle.xlContinuous;

            for (int i = 0; i < columnCount; i++)
            {
                sheet.Cells[rowIndex, i + 1] = columnHeaders[i];
            }

            return 1; // 1 ligne écrite
        }

        private int WriteTableSubHeader(xL.Worksheet sheet, int rowIndex, int columnCount, Color backgroundColor, string text)
        {
            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].Merge();
            sheet.Range[sheet.Cells[rowIndex, 1], sheet.Cells[rowIndex, columnCount]].BorderAround(xL.XlLineStyle.xlContinuous);
            sheet.Cells[rowIndex, 1].Font.Bold = true;
            sheet.Cells[rowIndex, 1].Interior.Color = ColorTranslator.ToOle(backgroundColor);
            sheet.Cells[rowIndex, 1].HorizontalAlignment = xL.XlHAlign.xlHAlignCenter;
            sheet.Cells[rowIndex, 1] = text;

            return 1; // 1 ligne écrite
        }
    }
}
